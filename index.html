<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détection Visages - Webcam Live</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <style>
        body { margin: 0; font-family: Arial; text-align: center; background: #f0f0f0; }
        #video { width: 640px; height: 480px; border: 2px solid #ccc; display: none; }
        #status { margin: 10px; font-size: 18px; color: #333; }
        button { padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Détection de Visages en Live</h1>
    <p id="status">Clique sur "Autoriser la Caméra" pour commencer. Les modèles se chargent en fond...</p>
    <br>
    <button id="startBtn" onclick="requestCamera()">Autoriser la Caméra</button>
    <video id="video" autoplay muted></video>
    <br>
    <button id="stopBtn" onclick="stopDetection()" style="display: none;">Arrêter</button>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        let stream = null;
        let detectionInterval = null;

        // Charger les modèles en fond
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.face-api.net/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.face-api.net/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.face-api.net/models')
        ]).then(() => {
            status.textContent = 'Modèles chargés ! Clique pour autoriser la caméra.';
        }).catch(err => {
            status.textContent = `Erreur chargement modèles : ${err.message}`;
        });

        function requestCamera() {
            startBtn.disabled = true;
            startBtn.textContent = 'Autorisation en cours...';
            status.textContent = 'Demande d\'accès à la caméra...';

            navigator.mediaDevices.getUserMedia({ video: {} })
                .then(handleSuccess)
                .catch(handleError);
        }

        function handleSuccess(s) {
            stream = s;
            video.srcObject = stream;
            video.style.display = 'block';
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            status.textContent = 'Caméra activée ! Détection en cours...';

            video.addEventListener('loadedmetadata', () => {
                const canvas = faceapi.createCanvasFromMedia(video);
                document.body.append(canvas);
                const displaySize = { width: video.width, height: video.height };
                faceapi.matchDimensions(canvas, displaySize);

                detectionInterval = setInterval(async () => {
                    // Options pour détection plus précise (seuil de confiance)
                    const options = new faceapi.TinyFaceDetectorOptions({ minDetectionConfidence: 0.5 });
                    const detections = await faceapi.detectAllFaces(video, options)
                        .withFaceLandmarks().withFaceDescriptors();
                    const resizedDetections = faceapi.resizeResults(detections, displaySize);
                    
                    // Effacer et redessiner
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Dessiner les carrés avec style custom (épais, vert)
                    const drawOptions = {
                        withLabels: true,
                        lineWidth: 3,  // Épaisseur pour visibilité
                        boxColor: '#00FF00',  // Vert fluo
                        labelColor: '#00FF00'
                    };
                    faceapi.draw.drawDetections(canvas, resizedDetections, drawOptions);
                    
                    status.textContent = `Visages détectés : ${detections.length} (carré suit en live)`;
                }, 50);  // Plus réactif : 50ms pour tracking fluide
            });
        }

        function handleError(err) {
            startBtn.disabled = false;
            startBtn.textContent = 'Autoriser la Caméra';
            let errorMsg = 'Erreur accès caméra : ';
            if (err.name === 'NotAllowedError') {
                errorMsg += 'Accès refusé. Clique encore pour réessayer, ou vérifie les paramètres de ton navigateur (HTTPS requis).';
            } else if (err.name === 'NotFoundError') {
                errorMsg += 'Aucune caméra trouvée. Vérifie ton hardware.';
            } else {
                errorMsg += err.message;
            }
            status.textContent = errorMsg;
        }

        function stopDetection() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }
            video.style.display = 'none';
            stopBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';
            startBtn.disabled = false;
            startBtn.textContent = 'Autoriser la Caméra';
            status.textContent = 'Détection arrêtée. Clique pour recommencer.';
        }
    </script>
</body>
</html>
