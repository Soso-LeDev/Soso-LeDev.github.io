<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scout ‚Äî Assistant IA Interactif Fullscreen</title>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>

<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,'Segoe UI',sans-serif;}
  html,body{height:100%;width:100%;background:#ece5dd;display:flex;flex-direction:column;}
  #chatContainer{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  #messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;}
  .msg{max-width:80%;padding:10px 14px;border-radius:12px;font-size:15px;line-height:1.4;word-wrap:break-word;}
  .msg.user{align-self:flex-end;background:#dcf8c6;border-bottom-right-radius:4px;}
  .msg.assistant{align-self:flex-start;background:#fff;border-bottom-left-radius:4px;}
  .meta{display:flex;justify-content:space-between;font-size:12px;color:#666;margin-bottom:4px;}
  #inputArea{display:flex;padding:10px;background:#f0f0f0;gap:8px;}
  #input{flex:1;padding:12px;border-radius:20px;border:none;font-size:16px;outline:none;}
  .btn{padding:12px 16px;border:none;border-radius:50%;cursor:pointer;background:#25d366;color:#fff;font-size:16px;}
  .btn:hover{background:#128c7e;}
  #btnGoogle{border-radius:12px;padding:10px 14px;}
</style>
</head>
<body>

<div id="chatContainer">
  <div id="messages"></div>
  <div id="inputArea">
    <input type="text" id="input" placeholder="√âcrivez un message... (ou /google recherche)" />
    <button class="btn" id="btnSend">‚ñ∂Ô∏è</button>
    <button id="btnGoogle">üîç Google</button>
    <button class="btn" id="btnClear">üóëÔ∏è</button>
  </div>
</div>

<script>
  // === Cl√©s API ===
  const apiUrl = "https://api.groq.com/openai/v1/chat/completions";
  const apiKey = "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";
  const googleApiKey = "AIzaSyCPD1222E1X5kX7N6PHFwLuyIeisrbIAKM";
  const googleCx = "24246487405284f60";

  const messagesNode = document.getElementById('messages');
  const input = document.getElementById('input');
  const btnSend = document.getElementById('btnSend');
  const btnGoogle = document.getElementById('btnGoogle');
  const btnClear = document.getElementById('btnClear');

  // Fonctions s√©curis√©es que Scout peut appeler
  function addMessage(text){
    const div = document.createElement('div');
    div.textContent = text;
    messagesNode.appendChild(div);
    messagesNode.scrollTop = messagesNode.scrollHeight;
  }
  function setBackgroundColor(color){
    document.body.style.backgroundColor = color;
  }
  function clearInput(){
    input.value = '';
  }

  // Ex√©cuter les commandes de Scout
  function executeScoutCommands(text){
    const commandRegex = /\[COMMAND\](.*?)\[\/COMMAND\]/gs;
    let match;
    while(match = commandRegex.exec(text)){
      try{
        eval(match[1]);
      } catch(e){
        console.error("Erreur en ex√©cutant une commande Scout :", e);
      }
    }
  }

  // Gestion des messages persistants
  let messages = JSON.parse(localStorage.getItem('chatHistory')) || [
    { role:'system', content:'Vous √™tes Scout, un assistant IA humain et chaleureux. Scout peut interagir avec le site via [COMMAND]...', time: new Date().toISOString() }
  ];

  function saveMessages(){ localStorage.setItem('chatHistory', JSON.stringify(messages)); }
  function renderMessage(msg){
    const wrapper = document.createElement('div');
    wrapper.className = 'msg ' + (msg.role==='user'?'user':'assistant');
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<span>${msg.role==='user'?'Vous':'Scout'}</span><span>${new Date(msg.time).toLocaleTimeString()}</span>`;
    const content = document.createElement('div');
    content.innerHTML = msg.role==='user'?msg.content:DOMPurify.sanitize(marked.parse(msg.content));
    wrapper.appendChild(meta); wrapper.appendChild(content);
    messagesNode.appendChild(wrapper);
    messagesNode.scrollTop = messagesNode.scrollHeight;
    if(msg.role==='assistant') executeScoutCommands(msg.content);
  }

  function addUserMessage(text){
    const msg = { role:'user', content:text, time:new Date().toISOString() };
    messages.push(msg); renderMessage(msg); saveMessages();
  }
  function addAssistantMessage(text){
    const msg = { role:'assistant', content:text, time:new Date().toISOString() };
    messages.push(msg); renderMessage(msg); saveMessages();
  }

  // Afficher l'historique au chargement
  messages.forEach(renderMessage);

  // Envoyer un message
  btnSend.addEventListener('click', async () => {
    const text = input.value.trim(); if(!text) return;
    addUserMessage(text); input.value='';
    addAssistantMessage('‚è≥ Scout r√©fl√©chit...');

    try{
      const siteContext = {
        pageTitle: document.title,
        numMessages: messages.length,
        lastUserMessage: messages.filter(m=>m.role==='user').slice(-1)[0]?.content || '',
        inputValue: input.value
      };

      const res = await fetch(apiUrl, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${apiKey}` },
        body: JSON.stringify({
          model:'meta-llama/llama-4-scout-17b-16e-instruct',
          messages:[
            {role:'system', content:`Vous √™tes Scout, un assistant IA humain et chaleureux. Contexte du site : ${JSON.stringify(siteContext)}. Scout peut interagir avec la page via [COMMAND]...`},
            {role:'user', content:text}
          ]
        })
      });
      const data = await res.json();
      const reply = data.choices?.[0]?.message?.content || '[R√©ponse vide]';
      addAssistantMessage(reply);
    }catch(err){
      addAssistantMessage('‚ùå Erreur Scout: '+err.message);
    }
  });

  // Recherche Google
  btnGoogle.addEventListener('click', async () => {
    const query = input.value.trim(); if(!query) return;
    addUserMessage(`/google ${query}`); input.value='';
    addAssistantMessage('üîç Recherche Google en cours...');

    try{
      const res = await fetch(`https://www.googleapis.com/customsearch/v1?key=${googleApiKey}&cx=${googleCx}&q=${encodeURIComponent(query)}`);
      const data = await res.json();
      let results = '‚ùå Aucun r√©sultat trouv√©.';
      if(data.items && data.items.length>0){
        results = data.items.slice(0,3).map((item,i)=>`**${i+1}. [${item.title}](${item.link})**\n${item.snippet||''}`).join('\n\n');
      }
      addAssistantMessage(results);
    }catch(err){
      addAssistantMessage('‚ùå Erreur Google: '+err.message);
    }
  });

  // Effacer conversation
  btnClear.addEventListener('click', ()=>{
    if(confirm('Voulez-vous vraiment effacer la conversation ?')){
      messages = [{ role:'system', content:'Vous √™tes Scout, un assistant IA humain et chaleureux. Scout peut interagir avec le site via [COMMAND]...', time:new Date().toISOString() }];
      localStorage.setItem('chatHistory', JSON.stringify(messages));
      messagesNode.innerHTML='';
      messages.forEach(renderMessage);
    }
  });

  // Entr√©e avec Enter
  input.addEventListener('keydown', e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();btnSend.click();}});
</script>

</body>
</html>
