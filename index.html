<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat avec Scout</title>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background-color: #ece5dd;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header {
    background-color: #075e54;
    color: white;
    padding: 16px;
    font-size: 18px;
    font-weight: bold;
    text-align: center;
    position: relative;
  }
  #clearBtn {
    position: absolute;
    right: 16px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
  }
  #chat {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background-image: url('https://i.imgur.com/3eF1QTT.png');
    background-size: cover;
  }
  .message {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 15px;
    line-height: 1.4;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .user {
    align-self: flex-end;
    background-color: #dcf8c6;
    border-bottom-right-radius: 0;
  }
  .bot {
    align-self: flex-start;
    background-color: #ffffff;
    border-bottom-left-radius: 0;
  }
  #inputArea {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ccc;
    background-color: #f0f0f0;
  }
  input {
    flex: 1;
    padding: 12px;
    font-size: 16px;
    border-radius: 20px;
    border: none;
    outline: none;
    background-color: white;
  }
  button {
    margin-left: 8px;
    padding: 12px 16px;
    background-color: #25d366;
    color: white;
    font-size: 16px;
    border: none;
    border-radius: 50%;
    cursor: pointer;
  }
  button:hover {
    background-color: #128c7e;
  }
  iframe.video {
    max-width: 100%;
    height: 200px;
    border-radius: 10px;
    margin-top: 8px;
  }
  a {
    color: #1a0dab;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  @media (max-width: 600px) {
    header { font-size: 16px; }
    .message { font-size: 14px; }
    input { font-size: 15px; }
  }
</style>
</head>
<body>
<header>
  Scout ‚Äì Assistant IA
  <button id="clearBtn" onclick="resetConversation()" title="Effacer la conversation">üóëÔ∏è</button>
</header>

<div id="chat"></div>

<div id="inputArea">
  <input type="text" id="userInput" placeholder="√âcrivez un message..." />
  <button onclick="sendMessage()">‚ñ∂Ô∏è</button>
</div>

<script>
const apiKey = "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";
const model = "meta-llama/llama-4-scout-17b-16e-instruct";
const apiUrl = "https://api.groq.com/openai/v1/chat/completions";

const googleApiKey = "AIzaSyCPD1222E1X5kX7N6PHFwLuyIeisrbIAKM";
const googleCx = "24246487405284f60";

const chatBox = document.getElementById("chat");
const inputField = document.getElementById("userInput");

const SYSTEM_PROMPT = {
  role: "system",
  content: `Vous √™tes Scout, un assistant IA humain, respectueux et chaleureux. Vous parlez √† Soan. Vous devez toujours le vouvoyer avec bienveillance. R√©pondez clairement, poliment, et avec empathie.`
};

let messages = JSON.parse(localStorage.getItem("chatHistory")) || [SYSTEM_PROMPT];

window.onload = () => {
  messages.forEach(msg => {
    if (msg.role === "user") {
      displayMessage("Soan", msg.content, "user");
    } else if (msg.role === "assistant") {
      displayMessage("Scout", msg.content, "bot");
    }
  });
};

function saveMessages() {
  localStorage.setItem("chatHistory", JSON.stringify(messages));
}

function escapeHTML(str) {
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function displayMessage(sender, text, type) {
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("message", type);
  msgDiv.innerHTML = type === "bot" ? text : escapeHTML(text);
  chatBox.appendChild(msgDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function detectIntent(message) {
  const msg = message.toLowerCase();

  // Wiki intent keywords
  const wikiKeywords = ["wiki", "wikip√©dia", "wikipedia"];

  // YouTube intent keywords
  const ytKeywords = ["vid√©o", "youtube", "montrer une vid√©o", "montre une vid√©o", "voir une vid√©o"];

  // Google search intent keywords (fallback)
  const googleKeywords = ["cherche", "trouve", "recherche", "que dit google", "peux-tu trouver", "informe-moi", "explique", "qu'est-ce que"];

  if (wikiKeywords.some(kw => msg.includes(kw))) return "wiki";
  if (ytKeywords.some(kw => msg.includes(kw))) return "youtube";
  if (googleKeywords.some(kw => msg.includes(kw))) return "google";

  return "chat";
}

async function searchWiki(query) {
  try {
    const url = `https://fr.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&utf8=&format=json&origin=*`;
    const res = await fetch(url);
    const data = await res.json();

    if (data.query.search.length === 0) {
      return `<em>‚ùå Aucun r√©sultat Wikip√©dia trouv√© pour "${escapeHTML(query)}".</em>`;
    }

    const first = data.query.search[0];
    const pageUrl = `https://fr.wikipedia.org/wiki/${encodeURIComponent(first.title.replace(/ /g, "_"))}`;

    return `<strong>üìö R√©sultat Wikip√©dia pour ¬´ ${escapeHTML(query)} ¬ª :</strong><br>
      <a href="${pageUrl}" target="_blank" style="color:#1a0dab;">${escapeHTML(first.title)}</a><br>
      <em>${escapeHTML(first.snippet.replace(/<\/?[^>]+(>|$)/g, ""))}...</em>`;
  } catch (e) {
    return `<em>‚ùå Erreur lors de la recherche Wikip√©dia : ${escapeHTML(e.message)}</em>`;
  }
}

async function searchGoogle(query) {
  try {
    const url = `https://www.googleapis.com/customsearch/v1?key=${googleApiKey}&cx=${googleCx}&q=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    const data = await res.json();

    if (!data.items || data.items.length === 0) {
      return `<em>‚ùå Aucun r√©sultat Google trouv√© pour ¬´ ${escapeHTML(query)} ¬ª.</em>`;
    }

    let html = `<strong>üîé R√©sultats Google pour ¬´ ${escapeHTML(query)} ¬ª :</strong><br><br>`;
    data.items.slice(0, 3).forEach((item, i) => {
      html += `<strong>${i + 1}. <a href="${item.link}" target="_blank" style="color:#1a0dab;">${escapeHTML(item.title)}</a></strong><br>`;
      if (item.snippet) html += `<em>${escapeHTML(item.snippet)}</em><br><br>`;
    });

    return html;
  } catch (e) {
    return `<em>‚ùå Erreur lors de la recherche Google : ${escapeHTML(e.message)}</em>`;
  }
}

async function searchYouTube(query) {
  try {
    // Recherche YouTube via API publique (limit√© sans cl√©) ‚Äî ici on fait une requ√™te simple via JSONP (pas id√©al en prod)
    // Pour d√©mo : on embarque la premi√®re vid√©o trouv√©e sur Youtube Search HTML

    const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&key=${googleApiKey}&maxResults=1`;
    const res = await fetch(searchUrl);
    const data = await res.json();

    if (!data.items || data.items.length === 0) {
      return `<em>‚ùå Aucune vid√©o YouTube trouv√©e pour ¬´ ${escapeHTML(query)} ¬ª.</em>`;
    }

    const videoId = data.items[0].id.videoId;
    const title = data.items[0].snippet.title;

    const embedHTML = `<strong>‚ñ∂Ô∏è Vid√©o YouTube pour ¬´ ${escapeHTML(query)} ¬ª :</strong><br>
      <a href="https://www.youtube.com/watch?v=${videoId}" target="_blank" style="color:#1a0dab;">${escapeHTML(title)}</a><br>
      <iframe class="video" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;

    return embedHTML;
  } catch (e) {
    return `<em>‚ùå Erreur lors de la recherche YouTube : ${escapeHTML(e.message)}</em>`;
  }
}

async function sendMessage() {
  const userMessage = inputField.value.trim();
  if (!userMessage) return;

  displayMessage("Soan", userMessage, "user");
  messages.push({ role: "user", content: userMessage });
  inputField.value = "";
  saveMessages();

  const intent = detectIntent(userMessage);

  try {
    if (intent === "wiki") {
      const reply = await searchWiki(userMessage);
      displayMessage("Scout", reply, "bot");
      messages.push({ role: "assistant", content: reply });
      saveMessages();
      return;
    }

    if (intent === "youtube") {
      const reply = await searchYouTube(userMessage);
      displayMessage("Scout", reply, "bot");
      messages.push({ role: "assistant", content: reply });
      saveMessages();
      return;
    }

    if (intent === "google") {
      const reply = await searchGoogle(userMessage);
      displayMessage("Scout", reply, "bot");
      messages.push({ role: "assistant", content: reply });
      saveMessages();
      return;
    }

    // Sinon appel IA classique
    const response = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: model,
        messages: messages
      })
    });

    const data = await response.json();
    const botReply = data.choices?.[0]?.message?.content || "[R√©ponse vide]";
    messages.push({ role: "assistant", content: botReply });
    displayMessage("Scout", botReply, "bot");
    saveMessages();

  } catch (error) {
    displayMessage("Scout", `‚ùå Erreur : ${error.message}`, "bot");
  }
}

inputField.addEventListener("keypress", function(e) {
  if (e.key === "Enter") sendMessage();
});

function resetConversation() {
  if (confirm("Souhaitez-vous vraiment effacer cette conversation ?")) {
    localStorage.removeItem("chatHistory");
    location.reload();
  }
}
</script>
</body>
</html>
