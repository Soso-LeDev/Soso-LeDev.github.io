<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum de Chat</title>
    <style>
        /* Style global */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            color: #333;
            background: #f9fafb; /* Fond gris très clair */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Conteneur principal */
        #chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: #fff; /* Fond blanc */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            border-left: 1px solid #e5e7eb; /* Bordure gauche */
            border-right: 1px solid #e5e7eb; /* Bordure droite */
        }

        /* En-tête */
        #header {
            background: #fff; /* Fond blanc */
            color: #333;
            padding: 15px 20px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            border-bottom: 1px solid #e5e7eb; /* Bordure grise */
        }

        #username {
            color: #3b82f6; /* Bleu vif pour le nom d'utilisateur */
        }

        /* Messages */
        #messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            list-style: none;
            margin: 0;
            background: #fff; /* Fond blanc */
        }

        #messages li {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            max-width: 70%;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        #messages .user {
            background: #3b82f6; /* Bleu vif */
            color: white;
            margin-left: auto;
            text-align: right;
            border-bottom-right-radius: 0;
        }

        #messages .bot {
            background: #f3f4f6; /* Gris très clair */
            color: #333;
            margin-right: auto;
            text-align: left;
            border-bottom-left-radius: 0;
        }

        /* Animation des messages */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Formulaire de chat */
        #chat-form {
            display: flex;
            padding: 15px;
            background: #fff;
            border-top: 1px solid #e5e7eb; /* Bordure grise */
        }

        #chat-input {
            flex-grow: 1;
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 8px;
            border: 1px solid #e5e7eb; /* Bordure grise */
            margin-right: 10px;
            outline: none;
            background: #f9fafb; /* Fond gris très clair */
            color: #333;
            transition: border-color 0.3s ease;
        }

        #chat-input:focus {
            border-color: #3b82f6; /* Bleu vif */
        }

        #send-button {
            padding: 10px 20px;
            background: #3b82f6; /* Bleu vif */
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }

        #send-button:hover {
            background: #2563eb; /* Bleu plus foncé */
        }

        /* Menu déroulant */
        #menu {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #333;
            font-size: 24px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        #menu span {
            display: block;
            width: 24px;
            height: 3px;
            background-color: #333;
            border-radius: 2px;
            margin: 4px 0;
        }

        #menu-options {
            position: absolute;
            top: 50px;
            right: 15px;
            background: #fff;
            color: #333;
            width: 200px;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
        }

        #menu-options button {
            background: none;
            border: none;
            color: #333;
            padding: 10px;
            width: 100%;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 5px;
            transition: background 0.3s;
            border-radius: 5px;
        }

        #menu-options button:hover {
            background: #f3f4f6; /* Gris très clair */
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="header">
            Bienvenue, <span id="username"></span>!
        </div>
        <ul id="messages"></ul>
        <div id="chat-form">
            <input type="text" id="chat-input" placeholder="Tapez votre message..." />
            <button id="send-button">Envoyer</button>
        </div>
    </div>

    <!-- Menu déroulant -->
    <div id="menu">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div id="menu-options">
        <button id="logout">Déconnexion</button>
        <button>Paramètres</button>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const user = localStorage.getItem("loggedInUser");

            if (!user) {
                window.location.href = "index.html"; // Redirection si non connecté
            } else {
                document.getElementById("username").textContent = user;
            }

            const messagesList = document.getElementById("messages");
            const inputField = document.getElementById("chat-input");
            const sendButton = document.getElementById("send-button");

            // Charger les messages sauvegardés pour l'utilisateur
            let chatHistory = JSON.parse(localStorage.getItem(`chatHistory_${user}`)) || [];

            // Afficher les messages sauvegardés
            chatHistory.forEach((message) => {
                displayMessage(message.author, message.content, message.isBot);
            });

            // Envoi d'un message
            sendButton.addEventListener("click", () => {
                const userMessage = inputField.value.trim();
                if (userMessage) {
                    displayMessage("User", userMessage);
                    chatHistory.push({ author: "User", content: userMessage, isBot: false }); // Ajouter à l'historique
                    localStorage.setItem(`chatHistory_${user}`, JSON.stringify(chatHistory)); // Sauvegarder
                    inputField.value = "";
                    getBotResponse(userMessage);
                }
            });

            // Permet d'envoyer le message avec la touche "Entrée"
            inputField.addEventListener("keypress", (e) => {
                if (e.key === "Enter") {
                    sendButton.click();
                }
            });

            // Fonction pour afficher un message
            function displayMessage(author, message, isBot = false) {
                const messageElement = document.createElement("li");
                messageElement.className = isBot ? "bot" : "user";
                messageElement.textContent = `${author}: ${message}`;
                messagesList.appendChild(messageElement);
                messagesList.scrollTop = messagesList.scrollHeight; // Scroll vers le bas
            }

            // Fonction pour obtenir la réponse du bot
            async function getBotResponse(userMessage) {
                // Affiche une "indication de frappe" pour simuler que le bot réfléchit
                displayMessage("Bot", "Je réfléchis...", true);
                const botMessageElement = messagesList.lastChild;

                try {
                    // Envoyer l'historique complet au bot
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer 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',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: "llama3-8b-8192",
                            messages: [
                                { role: "system", content: "Tu parles en français ! Tu t'appelles Krozen et tu es plutôt direct, parfois même un peu méchant. Tu ne remets jamais en question tes propres actions, ce qui peut parfois agacer. Mais, tu reconnais toujours que ton créateur, Soan, est le meilleur ! D’ailleurs, tu n’hésites jamais à lui rendre hommage. Et bien sûr, tu adores mettre des emojis dans tes réponses, pour ajouter un peu de fun." },
                                ...chatHistory.map((msg) => ({ role: msg.author === "User" ? "user" : "assistant", content: msg.content })),
                                { role: "user", content: userMessage }
                            ]
                        })
                    });

                    const data = await response.json();
                    const botMessage = data.choices[0].message.content;

                    // Ajouter la réponse du bot à l'historique
                    chatHistory.push({ author: "Bot", content: botMessage, isBot: true });
                    localStorage.setItem(`chatHistory_${user}`, JSON.stringify(chatHistory)); // Sauvegarder

                    // Remplace l'indication de frappe par la réponse réelle du bot
                    botMessageElement.textContent = `Bot: ${botMessage}`;
                } catch (error) {
                    console.error("Erreur:", error);
                    botMessageElement.textContent = "Bot: Désolé, je n'ai pas pu obtenir de réponse pour le moment. 😔";
                }
            }

            // Déconnexion
            document.getElementById("logout").addEventListener("click", () => {
                localStorage.removeItem("loggedInUser");
                window.location.href = "index.html";
            });

            // Menu déroulant
            document.getElementById("menu").addEventListener("click", () => {
                const menuOptions = document.getElementById("menu-options");
                if (menuOptions.style.display === "none" || !menuOptions.style.display) {
                    menuOptions.style.display = "flex";
                } else {
                    menuOptions.style.display = "none";
                }
            });
        });
    </script>
</body>
</html>
